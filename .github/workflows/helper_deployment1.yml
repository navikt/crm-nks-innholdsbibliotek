name: "[HELPER] Deployment"
on:
  workflow_dispatch:
    inputs:
      packageId:
        description: "Package ID"
        required: true
        type: string
      org:
        description: "Org (preprod, dev, uat, sit)"
        required: true
        type: choice
        options:
        - preprod
        - sit
        - crm-uat
        - uat
        - dev
env:
  SFDX_ENV: HEADER_ENV_REPLACER='"Dev"' DEPLOY_DESTINATION=DEV

jobs:
  debug:
    name: Debug Information
    runs-on: ubuntu-latest
    steps:
      - name: Print input values
        run: |
          echo "Org: ${{ inputs.org }}"
          echo "Package ID: ${{ inputs.packageId }}"
          echo "Initiator: ${{ github.actor }}"

  deploy-package:
    name: Deploy Package
    uses: navikt/crm-workflows-base/.github/workflows/deployPackage.yml@sfdx-env-support
    with:
      packageId: ${{ inputs.packageId }}
      org: ${{ inputs.org }}
      unpackagable: ./force-app/unpackagable-with-auto-deploy
      SFDX_ENV: ${{env.SFDX_ENV}}
    secrets: inherit
  
  publish-community:
    name: publish-community
    needs: [deploy-package]
    runs-on: ubuntu-latest
    steps:
      # Install SFDX
      - name: Install SFDX
        uses: navikt/crm-workflows-base/.github/actions/installSFDX@master

         # Authorize SFDX
      - name: Authorize SFDX
        uses: navikt/crm-workflows-base/.github/actions/authenticateOrg@master
        with:
          auth-url: ${{ needs.deploy-package.env.target }} #Set in the deploy package step
          alias: targetOrg
          setDefaultUsername: true
          setDefaultDevhubUsername: false
      
      - name: Publish
        run: |
          sfdx force:community:publish --name 'innholdsbibliotek'